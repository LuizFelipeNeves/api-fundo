services:
  go-api:
    build:
      context: ./go-api
      dockerfile: Dockerfile
    environment:
      PORT: "${PORT:-8080}"
      DATABASE_URL: "${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/fii?sslmode=disable}"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN:-}"
      TELEGRAM_WEBHOOK_SECRET: "${TELEGRAM_WEBHOOK_SECRET:-}"
      TELEGRAM_WEBHOOK_TOKEN: "${TELEGRAM_WEBHOOK_TOKEN:-}"
      API_ENDPOINT: "${API_ENDPOINT:-http://localhost:8080}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      LOG_FORMAT: "${LOG_FORMAT:-text}"
      LOG_REQUESTS: "${LOG_REQUESTS:-1}"
    ports:
      - "8080:8080"
    depends_on:
      - postgres

  go-worker:
    build:
      context: .
      dockerfile: go-worker/Dockerfile
    environment:
      FORCE_RUN_JOBS: ${FORCE_RUN_JOBS:-}
      DATABASE_URL: "${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/fii?sslmode=disable}"
      WORKER_MODE: "${WORKER_MODE:-normal}"
      WORKER_POOL_SIZE: "${WORKER_POOL_SIZE:-25}"
      SCHEDULER_INTERVAL_MS: "${SCHEDULER_INTERVAL_MS:-30000}"
      BATCH_SIZE: "${BATCH_SIZE:-50}"
      WORKER_STATS_INTERVAL: "${WORKER_STATS_INTERVAL:-60}"
      INTERVAL_FUND_LIST_MIN: "${INTERVAL_FUND_LIST_MIN:-30}"
      INTERVAL_FUND_DETAILS_MIN: "${INTERVAL_FUND_DETAILS_MIN:-15}"
      INTERVAL_COTATIONS_MIN: "${INTERVAL_COTATIONS_MIN:-5}"
      INTERVAL_COTATIONS_TODAY_MIN: "${INTERVAL_COTATIONS_TODAY_MIN:-5}"
      INTERVAL_INDICATORS_MIN: "${INTERVAL_INDICATORS_MIN:-30}"
      INTERVAL_DOCUMENTS_MIN: "${INTERVAL_DOCUMENTS_MIN:-25}"
      TZ: "America/Sao_Paulo"
    depends_on:
      - postgres
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1'

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: "${POSTGRES_DB:-fii}"
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres}"
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

volumes:
  pg_data:
  rabbit_data:
