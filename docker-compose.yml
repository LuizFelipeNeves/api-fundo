services:
  api:
    build: .
    environment:
      PORT: "${PORT:-3000}"
      DB_PATH: "${DB_PATH:-/data/data.sqlite}"
    ports:
      - "3000:3000"
    volumes:
      - ./data:/data

  jobs:
    build: .
    command: ["npm", "run", "jobs:cron"]
    environment:
      DB_PATH: "${DB_PATH:-/data/data.sqlite}"

      CRON_INTERVAL_MS: "${CRON_INTERVAL_MS:-300000}"

      CSRF_TOKEN: "${CSRF_TOKEN:-}"
      COOKIE: "${COOKIE:-}"
      INVESTIDOR10_HTML_TIMEOUT_MS: "${INVESTIDOR10_HTML_TIMEOUT_MS:-25000}"

      ENABLE_HISTORICAL_BACKFILL: "${ENABLE_HISTORICAL_BACKFILL:-true}"
      HISTORICAL_COTATIONS_DAYS: "${HISTORICAL_COTATIONS_DAYS:-365}"

      INDICATORS_CONCURRENCY: "${INDICATORS_CONCURRENCY:-5}"
      INDICATORS_MIN_INTERVAL_MIN: "${INDICATORS_MIN_INTERVAL_MIN:-360}"

      COTATIONS_TODAY_CONCURRENCY: "${COTATIONS_TODAY_CONCURRENCY:-5}"
      COTATIONS_TODAY_MIN_INTERVAL_MIN: "${COTATIONS_TODAY_MIN_INTERVAL_MIN:-5}"

      DOCUMENTS_CONCURRENCY: "${DOCUMENTS_CONCURRENCY:-5}"
      DOCUMENTS_MIN_INTERVAL_MIN: "${DOCUMENTS_MIN_INTERVAL_MIN:-360}"
      DIVIDENDS_CONCURRENCY: "${DIVIDENDS_CONCURRENCY:-3}"

      FNET_HOST_CONCURRENCY: "${FNET_HOST_CONCURRENCY:-2}"
      FNET_HOST_MIN_TIME_MS: "${FNET_HOST_MIN_TIME_MS:-120}"
      TOR_PROXY_ENABLED: "${TOR_PROXY_ENABLED:-0}"
      TOR_PROXY_OPTIONAL: "${TOR_PROXY_OPTIONAL:-1}"
      TOR_PROXY_MODE: "${TOR_PROXY_MODE:-fallback}"
      TOR_PROXY_SERVICE: "${TOR_PROXY_SERVICE:-tor}"
      TOR_PROXY_PORT: "${TOR_PROXY_PORT:-8118}"
    volumes:
      - ./data:/data

  tor:
    image: dperson/torproxy:latest
    profiles: ["tor"]
    environment:
      TOR_NewCircuitPeriod: "300"
      TOR_MaxCircuitDirtiness: "600"
    expose:
      - "8118"
