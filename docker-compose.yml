services:
  api-read:
    build: .
    command: ["bun", "run", "apps/api/src/index.ts"]
    environment:
      PORT: "${PORT:-8080}"
      DATABASE_URL: "${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/fii}"
      RABBITMQ_URL: "${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672}"
      RABBITMQ_HEARTBEAT: "${RABBITMQ_HEARTBEAT:-60}"
      TELEGRAM_QUEUE_NAME: "${TELEGRAM_QUEUE_NAME:-telegram.updates}"
      TELEGRAM_DLX: "${TELEGRAM_DLX:-telegram.dlx}"
      TELEGRAM_DLQ: "${TELEGRAM_DLQ:-telegram.dlq}"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN:-}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      LOG_FORMAT: "${LOG_FORMAT:-text}"
      LOG_REQUESTS: "${LOG_REQUESTS:-1}"
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - rabbitmq

  worker:
    build: .
    command: ["bun", "run", "apps/worker/src/index.ts"]
    environment:
      FORCE_RUN_JOBS: ${FORCE_RUN_JOBS:-}
      DATABASE_URL: "${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/fii}"
      RABBITMQ_URL: "${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672}"
      RABBITMQ_HEARTBEAT: "${RABBITMQ_HEARTBEAT:-60}"
      TELEGRAM_QUEUE_NAME: "${TELEGRAM_QUEUE_NAME:-telegram.updates}"
      COLLECT_REQUESTS_QUEUE: "${COLLECT_REQUESTS_QUEUE:-collector.requests}"
      COLLECT_RESULTS_QUEUE: "${COLLECT_RESULTS_QUEUE:-collector.results}"
      PERSIST_QUEUE_NAME: "${PERSIST_QUEUE_NAME:-persistence.write}"
      TELEGRAM_QUEUE_PREFETCH: "${TELEGRAM_QUEUE_PREFETCH:-4}"
      PIPELINE_PREFETCH: "${PIPELINE_PREFETCH:-8}"
      COLLECTOR_PREFETCH: "${COLLECTOR_PREFETCH:-6}"
      COLLECTOR_RETRY_BASE_MS: "${COLLECTOR_RETRY_BASE_MS:-500}"
      COLLECTOR_MAX_RETRIES: "${COLLECTOR_MAX_RETRIES:-5}"
      PERSIST_RETRY_BASE_MS: "${PERSIST_RETRY_BASE_MS:-500}"
      PERSIST_MAX_RETRIES: "${PERSIST_MAX_RETRIES:-6}"
      RESULTS_RETRY_BASE_MS: "${RESULTS_RETRY_BASE_MS:-500}"
      RESULTS_MAX_RETRIES: "${RESULTS_MAX_RETRIES:-6}"
      CRON_INTERVAL_MS: "${CRON_INTERVAL_MS:-60000}"
      SCHED_BATCH_SIZE: "${SCHED_BATCH_SIZE:-200}"
      SCHED_MIN_INTERVAL_MIN: "${SCHED_MIN_INTERVAL_MIN:-5}"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN:-}"
    depends_on:
      - postgres
      - rabbitmq

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: "${POSTGRES_DB:-fii}"
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres}"
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbit_data:/var/lib/rabbitmq

volumes:
  pg_data:
  rabbit_data:
