
---

# Arquitetura: Processamento Batch (a cada 5min)

## Premissas

- **Dados do FII** (/fiis/{code}) são cacheados no banco
- **Só buscar novamente** quando houver documento novo
- **Cotations históricas**: popular 1 vez (só BRL, ignorar EUR/USD)
- **Indicators**: atualizar a cada 5min
- **Cotations Today**: atualizar a cada 5min
- **Documentos**: verificar a cada 5min, se novo → buscar dados do /fiis/{code} em HTML + dividend yield
---

---

## Jobs (a cada 5min)

| Job | Frequencia | O que faz |
|-----|------------|-----------|
| `sync-funds-list` | */5 * * * * | Verifica novos fundos e adiciona ao banco |
| `sync-cotations-today` | */5 * * * * | Fetch cotations-today → cotations_today |
| `sync-indicators` | */5 * * * * | Fetch indicators → daily_data |
| `sync-documents` | */5 * * * * | Verifica FNET, se novo → extrai os dados basicos do fundo + dividend yield, e atualiza |
```

---

## API (Read-only)

| Endpoint | Query |
|----------|-------|
| `GET /api/fii` | SELECT * FROM fund_master |
| `GET /api/fii/{code}` | SELECT * FROM fund_master WHERE code |
| `GET /api/fii/{code}/indicators` | SELECT * FROM daily_data WHERE fund_code ORDER BY date |
| `GET /api/fii/{code}/cotations` | SELECT * FROM daily_data WHERE fund_code ORDER BY date |
| `GET /api/fii/{code}/cotations-today` | SELECT * FROM cotations_today WHERE fund_code ORDER BY timestamp |
| `GET /api/fii/{code}/documents` | SELECT * FROM documents WHERE fund_code ORDER BY published_date |

---

## Resumo das Requests

| Dados | Quando | Request |
|-------|--------|---------|
| dados basicos do fundo + dividend yield | Só quando há documento novo | GET /fiis/{code}/ + GET /api/fii/dividend-yield/{id}/mes |
| cotations históricas | 1 vez (inicial) | GET /api/fii/cotacoes/chart/{id}/365/true |
| indicators | A cada 5min | GET /api/fii/historico-indicadores/{id}/5 |
| cotations-today | A cada 5min | GET /api/quotations/one-day/{code}/ |
| documentos | A cada 5min | GET /fnet (sessão) + GET /pesquisar |